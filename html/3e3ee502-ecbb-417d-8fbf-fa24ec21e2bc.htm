<html><head><meta http-equiv="X-UA-Compatible" content="IE=edge" /><link rel="shortcut icon" href="../icons/favicon.ico" /><link rel="stylesheet" type="text/css" href="../styles/branding.css" /><link rel="stylesheet" type="text/css" href="../styles/branding-zh-CN.css" /><script type="text/javascript" src="../scripts/branding.js"> </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>贪婪加载</title><meta name="Language" content="zh-cn" /><meta name="Microsoft.Help.Id" content="3e3ee502-ecbb-417d-8fbf-fa24ec21e2bc" /><meta name="Description" content="通过仓库查询出实体，在使用这些实体时，除了使用实体自身的一般属性，往往还需要使用它的一些关系实体。虽然，实体关系都支持懒加载，使用者可以在真正使用这些关系属性时才从数据库中加载相应的数据，但是过多地使用懒加载会造成 N+1 性能问题（关于 N+1 问题，本文中有相关的介绍：OEA ORM 框架中的冗余属性设计http://www.cnblogs.com/zgynhqf/archive/2012/08/10/2633047." /><meta name="Microsoft.Help.ContentType" content="Concepts" /><meta name="BrandingAware" content="true" /><link type="text/css" rel="stylesheet" href="../styles/highlight.css" /><script type="text/javascript" src="../scripts/highlight.js"> </script><link rel="stylesheet" type="text/css" href="../styles/branding-Website.css" /><script type="text/javascript" src="../scripts/jquery-1.11.0.min.js"></script><script type="text/javascript" src="../scripts/branding-Website.js"></script><script type="text/javascript" src="../scripts/clipboard.min.js"></script></head><body onload="OnLoad('cs')"><input type="hidden" id="userDataCache" class="userDataStyle" /><div class="pageHeader" id="PageHeader">Rafy User Guide<form id="SearchForm" method="get" action="#" onsubmit="javascript:TransferToSearchPage(); return false;"><input id="SearchTextBox" type="text" maxlength="200" /><button id="SearchButton" type="submit"></button></form></div><div class="pageBody"><div class="leftNav" id="leftNav"><div id="tocNav"><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy User Guide" tocid="roottoc">Rafy User Guide</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy框架" tocid="69b641cf-d1fe-4f06-877f-b479d268a3fc">Rafy框架</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="c8e6cd25-c674-4cd1-9880-816d11f58eb8.htm" title="领域实体框架" tocid="c8e6cd25-c674-4cd1-9880-816d11f58eb8">领域实体框架</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="6b377084-3fc9-4bf6-94d7-bc9a42ed82a7.htm" title="实体仓库" tocid="6b377084-3fc9-4bf6-94d7-bc9a42ed82a7">实体仓库</a></div><div class="toclevel1" data-toclevel="1" data-childrenloaded="true"><a class="tocExpanded" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="59c80aec-c910-4880-b165-c3495ed5eb3e.htm" title="编写查询" tocid="59c80aec-c910-4880-b165-c3495ed5eb3e">编写查询</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="c7c6d07b-bb41-4590-a2a6-8b0b49ce1c0b.htm" title="Linq 查询" tocid="c7c6d07b-bb41-4590-a2a6-8b0b49ce1c0b">Linq 查询</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="6d65448c-b51b-4c9b-9500-f6b7a48b1188.htm" title="SqlTree 查询" tocid="6d65448c-b51b-4c9b-9500-f6b7a48b1188">SqlTree 查询</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="02f40bcc-1ff3-4abc-b4a9-2dea57d516ce.htm" title="通用查询条件(CommonQueryCriteria)" tocid="02f40bcc-1ff3-4abc-b4a9-2dea57d516ce">通用查询条件(CommonQueryCriteria)</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="c2eced2c-e434-4d53-a06d-fbc518fbddf5.htm" title="Sql 查询" tocid="c2eced2c-e434-4d53-a06d-fbc518fbddf5">Sql 查询</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="ae9a2512-1528-401a-ac4f-502304a7ae03.htm" title="分页查询" tocid="ae9a2512-1528-401a-ac4f-502304a7ae03">分页查询</a></div><div class="toclevel2 current" data-toclevel="2"><a data-tochassubtree="false" href="3e3ee502-ecbb-417d-8fbf-fa24ec21e2bc.htm" title="贪婪加载" tocid="3e3ee502-ecbb-417d-8fbf-fa24ec21e2bc">贪婪加载</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="56b9e7bc-2656-4bde-95dd-69e71aeafc6a.htm" title="数据行数查询" tocid="56b9e7bc-2656-4bde-95dd-69e71aeafc6a">数据行数查询</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="55180b16-9fda-42a1-8c4f-27d037aeae76.htm" title="表格查询" tocid="55180b16-9fda-42a1-8c4f-27d037aeae76">表格查询</a></div></div><div id="tocResizableEW" onmousedown="OnMouseDown(event);"></div><div id="TocResize" class="tocResize"><img id="ResizeImageIncrease" src="../icons/TocOpen.gif" onclick="OnIncreaseToc()" alt="点击或拖拽改变大小" title="点击或拖拽改变大小" /><img id="ResizeImageReset" src="../icons/TocClose.gif" style="display:none" onclick="OnResetToc()" alt="点击或拖拽改变大小" title="点击或拖拽改变大小" /></div></div><div class="topicContent" id="TopicContent"><table class="titleTable"><tr><td class="titleColumn"><h1>贪婪加载</h1></td></tr></table><span class="introStyle"></span> <div class="introduction"><p>
                通过仓库查询出实体，在使用这些实体时，除了使用实体自身的一般属性，往往还需要使用它的一些关系实体。虽然，实体关系都支持懒加载，使用者可以在真正使用这些关系属性时才从数据库中加载相应的数据，但是过多地使用懒加载会造成 N+1 性能问题（关于 N+1 问题，本文中有相关的介绍：<a href="http://www.cnblogs.com/zgynhqf/archive/2012/08/10/2633047.html" target="_blank">OEA ORM 框架中的冗余属性设计</a> ）。为了解决 N+1 问题，除了使用上文中提到了定义冗余属性的方法，还可以使用本文将介绍的贪婪加载方法：在查询一个或一组实体的同时，一并查询出实体所拥有的这些关系属性所对应的实体。
            </p></div><div class="collapsibleAreaRegion" id="define"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID1RB')" onkeypress="SectionExpandCollapse_CheckKey('ID1RB', event)" tabindex="0"><img id="ID1RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />定义查询</span></div><div id="ID1RBSection" class="collapsibleSection"><p>
                    Rafy 中的关系有引用关系和组合关系，这些关系都可以声明为贪婪加载。
                </p><p>
                    在仓库中编写的查询时，如果该查询需要支持贪婪加载，那么需要为查询添加一个额外的参数，类型为 <span class="code">EagerLoadOptions</span>。并将其从公有接口层一直传递给数据层，并由数据层传递给底层框架的查询 API，最终框架会根据其中的内容，来加载相应的实体关系。
                </p><p>
                    以下代码示例通过添加 <span class="code">EagerLoadOptions eagerLoad</span> 可选参数，使得 <span class="code">SearchByCode</span> 方法支持贪婪加载：
                </p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAACAAA');return false;" title="复制">复制</a></div></div><div id="ID0EAAACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">[RepositoryQuery]
<span class="highlight-keyword">public</span> <span class="highlight-keyword">virtual</span> WarehouseList SearchByCode(<span class="highlight-keyword">string</span> code, EagerLoadOptions eagerLoad = <span class="highlight-keyword">null</span>)
{
    <span class="highlight-keyword">var</span> q = <span class="highlight-keyword">this</span>.CreateLinqQuery();
    q = q.Where(e =&gt; e.Code.Contains(code));
    <span class="highlight-keyword">return</span> (WarehouseList)<span class="highlight-keyword">this</span>.QueryData(q, eagerLoad: eagerLoad);
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAACAAA");</script></div><div class="collapsibleAreaRegion" id="use"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID2RB')" onkeypress="SectionExpandCollapse_CheckKey('ID2RB', event)" tabindex="0"><img id="ID2RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />如何使用</span></div><div id="ID2RBSection" class="collapsibleSection"><p>
                    使用者在使用查询时，可以通过 <span class="code">EagerLoadOptions</span> 参数来定义该查询所需要同时贪婪加载的实体的关系列表。
                </p><p>以下代码示例如何在搜索编码中含有"001"的仓库实体的同时，一并加载出仓库的管理员及仓库下所有的货品信息、货品类别信息（其中，管理员是仓库的引用属性；货品是仓库的组合子属性；货品类别是货品的引用属性）：</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAABAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAABAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAABAAA');return false;" title="复制">复制</a></div></div><div id="ID0EAAABAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-comment">//定义加载仓库时，需要同时加载的所有关系属性。</span>
<span class="highlight-keyword">var</span> eagerLoad = <span class="highlight-keyword">new</span> EagerLoadOptions()
    .LoadWith(Warehouse.AdministratorProperty)
    .LoadWith(Warehouse.ProductListProperty)
    .LoadWith(Product.ProductCategoryProperty);

<span class="highlight-comment">//一次性将数据全部加载到内存中。</span>
<span class="highlight-keyword">var</span> repo = RF.ResolveInstance&lt;WarehouseRepository&gt;();
<span class="highlight-keyword">var</span> warehouseList = repo.SearchByCode(<span class="highlight-literal">"001"</span>, eagerLoad);

<span class="highlight-comment">//由于已经使用贪婪加载，所以数据都已经查询到内存中。下面的循环将不会再触发懒加载。</span>
<span class="highlight-keyword">foreach</span>(<span class="highlight-keyword">var</span> warehouse <span class="highlight-keyword">in</span> warehouseList)
{
    <span class="highlight-keyword">var</span> administrator = warehouse.Administrator;
    <span class="highlight-keyword">foreach</span>(<span class="highlight-keyword">var</span> product <span class="highlight-keyword">in</span> warehouse.ProductList)
    {
        <span class="highlight-keyword">var</span> productCategory = product.ProductCategory;

        <span class="highlight-comment">//使用 warehouse、administrator、product、productCategory</span>
        doSomething(warehouse, administrator, product, productCategory);
    }
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAABAAA");</script></div></div></div><div id="pageFooter" class="pageFooter">有问题请联系 9474649@qq.com。<div class="feedbackLink">有关这个主题的评论请发邮件到
        <a id="HT_MailLink" href="mailto:9474649%40qq.com?Subject=Rafy User Guide">发送反馈</a></div>
        <script type="text/javascript">
        var HT_mailLink = document.getElementById("HT_MailLink");
        var HT_mailLinkText = HT_mailLink.innerHTML;
        HT_mailLink.href += ": " + document.title + "\u0026body=" + encodeURIComponent("Your feedback is used to improve the documentation and the product. Your e-mail address will not be used for any other purpose and is disposed of after the issue you report is resolved. While working to resolve the issue that you report, you may be contacted via e-mail to get further details or clarification on the feedback you sent. After the issue you report has been addressed, you may receive an e-mail to let you know that your feedback has been addressed.");
        HT_mailLink.innerHTML = HT_mailLinkText;
        </script></div></body></html>