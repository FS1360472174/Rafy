<html><head><meta http-equiv="X-UA-Compatible" content="IE=edge" /><link rel="shortcut icon" href="../icons/favicon.ico" /><link rel="stylesheet" type="text/css" href="../styles/branding.css" /><link rel="stylesheet" type="text/css" href="../styles/branding-zh-CN.css" /><script type="text/javascript" src="../scripts/branding.js"> </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>幽灵插件</title><meta name="Language" content="zh-cn" /><meta name="Microsoft.Help.Id" content="f662f88a-8221-49f4-bc38-901134ea893e" /><meta name="Description" content="本文将解释 Rafy 框架中的幽灵插件的场景、使用方法、原理。" /><meta name="Microsoft.Help.ContentType" content="Concepts" /><meta name="BrandingAware" content="true" /><link type="text/css" rel="stylesheet" href="../styles/highlight.css" /><script type="text/javascript" src="../scripts/highlight.js"> </script><link rel="stylesheet" type="text/css" href="../styles/branding-Website.css" /><script type="text/javascript" src="../scripts/jquery-1.11.0.min.js"></script><script type="text/javascript" src="../scripts/branding-Website.js"></script><script type="text/javascript" src="../scripts/clipboard.min.js"></script></head><body onload="OnLoad('cs')"><input type="hidden" id="userDataCache" class="userDataStyle" /><div class="pageHeader" id="PageHeader">Rafy User Guide<form id="SearchForm" method="get" action="#" onsubmit="javascript:TransferToSearchPage(); return false;"><input id="SearchTextBox" type="text" maxlength="200" /><button id="SearchButton" type="submit"></button></form></div><div class="pageBody"><div class="leftNav" id="leftNav"><div id="tocNav"><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy User Guide" tocid="roottoc">Rafy User Guide</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy框架" tocid="69b641cf-d1fe-4f06-877f-b479d268a3fc">Rafy框架</a></div><div class="toclevel1" data-toclevel="1" data-childrenloaded="true"><a class="tocExpanded" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="2a81b03d-24b4-4463-9e57-34cbaa105adf.htm" title="现有插件" tocid="2a81b03d-24b4-4463-9e57-34cbaa105adf">现有插件</a></div><div class="toclevel2 current" data-toclevel="2"><a data-tochassubtree="false" href="f662f88a-8221-49f4-bc38-901134ea893e.htm" title="幽灵插件" tocid="f662f88a-8221-49f4-bc38-901134ea893e">幽灵插件</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="1ce3c19a-3de6-4956-afd0-a7fc6e577768.htm" title="流水号插件" tocid="1ce3c19a-3de6-4956-afd0-a7fc6e577768">流水号插件</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="e13240fe-3c80-47e1-9645-f154e8b72a83.htm" title="时间戳插件" tocid="e13240fe-3c80-47e1-9645-f154e8b72a83">时间戳插件</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="507d98b9-f88c-48bf-a12b-dded5e021340.htm" title="帐户插件" tocid="507d98b9-f88c-48bf-a12b-dded5e021340">帐户插件</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="c4919121-bad5-4b1d-b3c2-6a889590af53.htm" title="RBAC 插件" tocid="c4919121-bad5-4b1d-b3c2-6a889590af53">RBAC 插件</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="5554eab4-a79f-473c-ac64-d028e7e39145.htm" title="多国语言插件" tocid="5554eab4-a79f-473c-ac64-d028e7e39145">多国语言插件</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="064b28a9-25ac-49f1-a964-56bbea3fac89.htm" title="附件插件" tocid="064b28a9-25ac-49f1-a964-56bbea3fac89">附件插件</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="87a44564-2ce0-4065-8174-ce612bc1583b.htm" title="大批量导入实体插件" tocid="87a44564-2ce0-4065-8174-ce612bc1583b">大批量导入实体插件</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="d862044a-9278-47cc-857e-3ccbdd3d3ed6.htm" title="文件存储插件" tocid="d862044a-9278-47cc-857e-3ccbdd3d3ed6">文件存储插件</a></div></div><div id="tocResizableEW" onmousedown="OnMouseDown(event);"></div><div id="TocResize" class="tocResize"><img id="ResizeImageIncrease" src="../icons/TocOpen.gif" onclick="OnIncreaseToc()" alt="点击或拖拽改变大小" title="点击或拖拽改变大小" /><img id="ResizeImageReset" src="../icons/TocClose.gif" style="display:none" onclick="OnResetToc()" alt="点击或拖拽改变大小" title="点击或拖拽改变大小" /></div></div><div class="topicContent" id="TopicContent"><table class="titleTable"><tr><td class="titleColumn"><h1>幽灵插件</h1></td></tr></table><span class="introStyle"></span> <div class="introduction"><p>本文将解释 Rafy 框架中的幽灵插件的场景、使用方法、原理。</p><p>本页包含以下内容：</p><ul class="autoOutline"><li class="outlineSectionEntry"><a href="#senarios">场景</a></li><li class="outlineSectionEntry"><a href="#howto">使用方法</a></li><li class="outlineSectionEntry"><a href="#effect">效果</a></li><li class="outlineSectionEntry"><a href="#theory">原理</a></li><li class="outlineSectionEntry"><a href="#seeAlsoSection">参见</a></li></ul></div><div class="collapsibleAreaRegion" id="senarios"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID0RB')" onkeypress="SectionExpandCollapse_CheckKey('ID0RB', event)" tabindex="0"><img id="ID0RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />场景</span></div><div id="ID0RBSection" class="collapsibleSection"><p>在开发各类数据库应用系统时，往往需要在删除数据时不是真正地删除数据，而只是把数据标识为‘已删除’状态。这些数据在业务逻辑上是已经完全删除、不可用的数据，但是不能在数据库中真正的把它们删除，而是需要永久保留这些历史数据。即开发人员常说的‘假删除’功能。</p><p>这种需求往往是系统级的。往往不是针对某一张表，而很可能是针对系统中的所有表都需要实现‘假删除’功能。</p></div><div class="collapsibleAreaRegion" id="howto"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID2RB')" onkeypress="SectionExpandCollapse_CheckKey('ID2RB', event)" tabindex="0"><img id="ID2RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />使用方法</span></div><div id="ID2RBSection" class="collapsibleSection"><p>由于这种需求比较常见，所以我们决定专门为该功能写一个独立的 Rafy 插件。这样，开发人员需要实现假删除功能时，只需要引用该插件后，系统中所有删除的实体都自动变为‘幽灵’，同时这些幽灵数据在仓库的所有查询中都将被自动过滤。</p><h3 class="procedureSubHeading">步骤</h3><div class="subSection"><ol><li><p>通过 Nuget Package Manager 搜索并安装 Rafy.Domain.EntityPhantom 插件。</p><div class="mediaNear"><img alt="幽灵插件02" src="../media/幽灵插件02.png" /></div></li><li><p>在 DomainApp 中添加该插件：</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAAABAAADAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAAABAAADAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID1EAAABAAADAAA');return false;" title="复制">复制</a></div></div><div id="ID1EAAABAAADAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">class</span> JXCApp : DomainApp
{
    <span class="highlight-keyword">protected</span> <span class="highlight-keyword">override</span> <span class="highlight-keyword">void</span> InitEnvironment()
    {
        <span class="highlight-comment">//添加幽灵插件到 Rafy 应用程序集中。</span>
        RafyEnvironment.DomainPlugins.Add(<span class="highlight-keyword">new</span> Rafy.Domain.EntityPhantom.EntityPhantomPlugin());
        RafyEnvironment.DomainPlugins.Add(<span class="highlight-keyword">new</span> JXCPlugin());

        <span class="highlight-keyword">base</span>.InitEnvironment();
    }
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAAABAAADAAA");</script></li><li><p>为需要幽灵功能的实体打开该功能，需要在实体元数据配置中进行配置： </p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAAAAAAADAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAAAAAAADAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID1EAAAAAAADAAA');return false;" title="复制">复制</a></div></div><div id="ID1EAAAAAAADAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">internal</span> <span class="highlight-keyword">class</span> UserConfig : JXCEntityConfig&lt;User&gt;
{
    <span class="highlight-keyword">protected</span> <span class="highlight-keyword">override</span> <span class="highlight-keyword">void</span> ConfigMeta()
    {
        Meta.MapTable().MapAllProperties();

        <span class="highlight-comment">//在实体配置中加入此行代码，为实体启用幽灵功能。</span>
        Meta.EnablePhantoms();
    }
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAAAAAAADAAA");</script></li></ol></div></div><div class="collapsibleAreaRegion" id="effect"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID3RB')" onkeypress="SectionExpandCollapse_CheckKey('ID3RB', event)" tabindex="0"><img id="ID3RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />效果</span></div><div id="ID3RBSection" class="collapsibleSection"><p>经过上面几步的配置，User 实体类就已经开启了幽灵功能。开启后，对实体会有以下的影响：</p><ul><li><p>所有继承自 Entity 的实体都会统一的添加一个 IsPhantom 的属性。这个属性表示这个实体是否为‘幽灵’，即已经删除的数据。</p></li><li><p>开发者可以使用 Meta.EnablePhantoms() 来为某个指定的实体类型开启‘幽灵’功能。</p></li><li><p>开启该功能的实体的 IsPhantom 属性会自动映射到数据库中。</p></li><li><p>在保存实体时，如果要删除一个聚合实体，则这个聚合中的所有实体都将会被标记为‘幽灵’状态。</p></li><li><p>在查询实体时，所有的查询，都将会自动过滤掉所有‘幽灵’状态的数据。（手写 SQL 查询的场景不在考虑范围内。）</p></li><li><p>使用批量导入数据插件进行数据的批量导入时，批量删除的实体同样都会被标记为‘幽灵’状态。</p></li></ul><p>运行程序后，数据库中的字段，已经自动添加上 IsPhantom 字段了：</p><div class="mediaNear"><img alt="幽灵插件01" src="../media/幽灵插件01.png" /></div><p>在使用 GetAll 查询所有实体时，框架自动加上一 IsPhantom = false 的过滤条件：</p><div class="codeSnippetContainer"><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EACACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID1EACACAAA');return false;" title="复制">复制</a></div></div><div id="ID1EACACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">SELECT</span> *
<span class="highlight-keyword">FROM</span> [<span class="highlight-keyword">User</span>]
<span class="highlight-keyword">WHERE</span> [<span class="highlight-keyword">User</span>].[IsPhantom] = @p0
<span class="highlight-keyword">ORDER</span> <span class="highlight-keyword">BY</span> [<span class="highlight-keyword">User</span>].[Id] <span class="highlight-keyword">ASC</span>
Parameters:False</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EACACAAA");</script><p>数据的删除，变为更新表中对应行的 IsPhantom 字段为 True：</p><div class="codeSnippetContainer"><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAAACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID1EAAACAAA');return false;" title="复制">复制</a></div></div><div id="ID1EAAACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">UPDATE</span> [<span class="highlight-keyword">User</span>] <span class="highlight-keyword">SET</span> [Name] = @p0,[IsPhantom] = @p1 <span class="highlight-keyword">WHERE</span> [Id] = @p2
Parameters:"Name",True,<span class="highlight-number">3</span></pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAAACAAA");</script></div><div class="collapsibleAreaRegion" id="theory"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID4RB')" onkeypress="SectionExpandCollapse_CheckKey('ID4RB', event)" tabindex="0"><img id="ID4RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />原理</span></div><div id="ID4RBSection" class="collapsibleSection"><p>幽灵插件的原理比较简单。在 Rafy 框架的基础上，以插件的形式对 Rafy 框架中实体的数据层进行了扩展。在启用实体的幽灵功能后，该实体的 DataProvider 类型的 Deleting、Querying 事件都会被监听并扩展：</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EABABAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EABABAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID1EABABAAA');return false;" title="复制">复制</a></div></div><div id="ID1EABABAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-comment">/// &lt;summary&gt;</span>
<span class="highlight-comment">/// 数据的删除、查询的拦截器。</span>
<span class="highlight-comment">/// &lt;/summary&gt;</span>
<span class="highlight-keyword">internal</span> <span class="highlight-keyword">static</span> <span class="highlight-keyword">class</span> PhantomDataInterceptor
{
    <span class="highlight-keyword">internal</span> <span class="highlight-keyword">static</span> <span class="highlight-keyword">void</span> Intercept()
    {
        RepositoryDataProvider.Deleting += RepositoryDataProvider_Deleting;
        RepositoryDataProvider.Querying += RepositoryDataProvider_Querying;
    }
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EABABAAA");</script><p>在查询时，框架自动分析出当前查询的 SQL 树，并在主查询上加上 IsPhantom = false 的过滤条件。</p></div><div class="collapsibleAreaRegion" id="seeAlsoSection"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID5RB')" onkeypress="SectionExpandCollapse_CheckKey('ID5RB', event)" tabindex="0"><img id="ID5RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />参见</span></div><div id="ID5RBSection" class="collapsibleSection"><h4 class="subHeading">其他资源</h4><div class="seeAlsoStyle"><a href="http://www.cnblogs.com/zgynhqf/p/5086644.html" title="Rafy 框架 - 幽灵插件（假删除）" target="_blank">Rafy 框架 - 幽灵插件（假删除）</a></div></div></div></div><div id="pageFooter" class="pageFooter">有问题请联系 9474649@qq.com。<div class="feedbackLink">有关这个主题的评论请发邮件到
        <a id="HT_MailLink" href="mailto:9474649%40qq.com?Subject=Rafy User Guide">发送反馈</a></div>
        <script type="text/javascript">
        var HT_mailLink = document.getElementById("HT_MailLink");
        var HT_mailLinkText = HT_mailLink.innerHTML;
        HT_mailLink.href += ": " + document.title + "\u0026body=" + encodeURIComponent("Your feedback is used to improve the documentation and the product. Your e-mail address will not be used for any other purpose and is disposed of after the issue you report is resolved. While working to resolve the issue that you report, you may be contacted via e-mail to get further details or clarification on the feedback you sent. After the issue you report has been addressed, you may receive an e-mail to let you know that your feedback has been addressed.");
        HT_mailLink.innerHTML = HT_mailLinkText;
        </script></div></body></html>