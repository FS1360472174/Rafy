<html><head><meta http-equiv="X-UA-Compatible" content="IE=edge" /><link rel="shortcut icon" href="../icons/favicon.ico" /><link rel="stylesheet" type="text/css" href="../styles/branding.css" /><link rel="stylesheet" type="text/css" href="../styles/branding-zh-CN.css" /><script type="text/javascript" src="../scripts/branding.js"> </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>多数据源切换</title><meta name="Language" content="zh-cn" /><meta name="Microsoft.Help.Id" content="1d3cd55d-9f80-4a63-812b-fc17851b3ab0" /><meta name="Description" content="大型应用中我们常对数据进行切分，并且采用多个数据库实例进行管理，这样可以有效提高系统的水平伸缩性。比如常见的读写分离。本节就是描述如何实现多个数据源切换。" /><meta name="Microsoft.Help.ContentType" content="Concepts" /><meta name="BrandingAware" content="true" /><link type="text/css" rel="stylesheet" href="../styles/highlight.css" /><script type="text/javascript" src="../scripts/highlight.js"> </script><link rel="stylesheet" type="text/css" href="../styles/branding-Website.css" /><script type="text/javascript" src="../scripts/jquery-1.11.0.min.js"></script><script type="text/javascript" src="../scripts/branding-Website.js"></script><script type="text/javascript" src="../scripts/clipboard.min.js"></script></head><body onload="OnLoad('cs')"><input type="hidden" id="userDataCache" class="userDataStyle" /><div class="pageHeader" id="PageHeader">Rafy User Guide<form id="SearchForm" method="get" action="#" onsubmit="javascript:TransferToSearchPage(); return false;"><input id="SearchTextBox" type="text" maxlength="200" /><button id="SearchButton" type="submit"></button></form></div><div class="pageBody"><div class="leftNav" id="leftNav"><div id="tocNav"><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy User Guide" tocid="roottoc">Rafy User Guide</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy框架" tocid="69b641cf-d1fe-4f06-877f-b479d268a3fc">Rafy框架</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="c8e6cd25-c674-4cd1-9880-816d11f58eb8.htm" title="领域实体框架" tocid="c8e6cd25-c674-4cd1-9880-816d11f58eb8">领域实体框架</a></div><div class="toclevel1" data-toclevel="1" data-childrenloaded="true"><a class="tocExpanded" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="0f6e3552-029f-4a32-9655-e4b6fb22edcc.htm" title="对象关系映射" tocid="0f6e3552-029f-4a32-9655-e4b6fb22edcc">对象关系映射</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="eba03db2-2a71-4499-9dcd-99e0c37fe10e.htm" title="配置映射" tocid="eba03db2-2a71-4499-9dcd-99e0c37fe10e">配置映射</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="8b3a3b78-9e6a-4558-938d-7692ae6aaa8f.htm" title="继承映射" tocid="8b3a3b78-9e6a-4558-938d-7692ae6aaa8f">继承映射</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="12520633-1fbf-45dc-aca8-c4089b5c90e0.htm" title="SQL 语句日志" tocid="12520633-1fbf-45dc-aca8-c4089b5c90e0">SQL 语句日志</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="b40cd779-ec8a-469d-82f5-bd99128561c4.htm" title="数据库同步功能" tocid="b40cd779-ec8a-469d-82f5-bd99128561c4">数据库同步功能</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="99366b1b-7583-4c95-9f78-3178b0bd50f9.htm" title="为数据库生成注释" tocid="99366b1b-7583-4c95-9f78-3178b0bd50f9">为数据库生成注释</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="ef53c777-dd02-4a01-98c9-7dcc49489cec.htm" title="多数据库支持" tocid="ef53c777-dd02-4a01-98c9-7dcc49489cec">多数据库支持</a></div><div class="toclevel2 current" data-toclevel="2"><a data-tochassubtree="false" href="1d3cd55d-9f80-4a63-812b-fc17851b3ab0.htm" title="多数据源切换" tocid="1d3cd55d-9f80-4a63-812b-fc17851b3ab0">多数据源切换</a></div></div><div id="tocResizableEW" onmousedown="OnMouseDown(event);"></div><div id="TocResize" class="tocResize"><img id="ResizeImageIncrease" src="../icons/TocOpen.gif" onclick="OnIncreaseToc()" alt="点击或拖拽改变大小" title="点击或拖拽改变大小" /><img id="ResizeImageReset" src="../icons/TocClose.gif" style="display:none" onclick="OnResetToc()" alt="点击或拖拽改变大小" title="点击或拖拽改变大小" /></div></div><div class="topicContent" id="TopicContent"><table class="titleTable"><tr><td class="titleColumn"><h1>多数据源切换</h1></td></tr></table><span class="introStyle"></span> <div class="introduction"><p>大型应用中我们常对数据进行切分，并且采用多个数据库实例进行管理，这样可以有效提高系统的水平伸缩性。比如常见的读写分离。本节就是描述如何实现多个数据源切换。</p><p>本页包含以下内容：</p><ul class="autoOutline"><li class="outlineSectionEntry"><a href="#Section0">说明</a></li><li class="outlineSectionEntry"><a href="#Section2">Repository 数据源切换</a></li><li class="outlineSectionEntry"><a href="#Section1">数据库生成切换</a></li><li class="outlineSectionEntry"><a href="#notice">注意</a></li></ul></div><div class="collapsibleAreaRegion" id="Section0"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID1RB')" onkeypress="SectionExpandCollapse_CheckKey('ID1RB', event)" tabindex="0"><img id="ID1RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />说明</span></div><div id="ID1RBSection" class="collapsibleSection"><p>
          实体 Repository 是以单例的形式存在的，每个Repository 都有唯一的RdbDataProvider，它的数据库连接字符串是全局共享的，一旦更新数据源会全部更新。
          我们采用一种线程安全上下文的变量，来实现 Repository 数据源的切换，在线程上下文的作用域内，Repository 使用新的数据源，离开作用域，即还原为默认的数据源。

        </p><p>Repository 数据源的切换，是通过 RdbDataProvider 类中的 RedirectDbSetting 方法来完成的。</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAAEAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAAEAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAAEAAA');return false;" title="复制">复制</a></div></div><div id="ID0EAAAEAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-comment">/// &lt;summary&gt;</span>
<span class="highlight-comment">/// 切换实体仓储的数据源</span>
<span class="highlight-comment">/// 在当前上下文中原仓储的数据源都会切换为新的数据源</span>
<span class="highlight-comment">/// 不支持跨数据库类型切换例如：从MySql切换到SQL Server</span>
<span class="highlight-comment">/// &lt;/summary&gt;</span>
<span class="highlight-comment">/// &lt;param name="oldDbSettingName"&gt;实体仓储旧的数据源&lt;/param&gt;</span>
<span class="highlight-comment">/// &lt;param name="newDbSettingName"&gt;实体仓储新的数据源&lt;/param&gt;</span>
<span class="highlight-comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="highlight-keyword">public</span> <span class="highlight-keyword">static</span> IDisposable RedirectDbSetting(<span class="highlight-keyword">string</span> oldDbSettingName, <span class="highlight-keyword">string</span> newDbSettingName)
{
    <span class="highlight-keyword">var</span> contextItemDic = ShareDbSettingContextItem.Value ?? <span class="highlight-keyword">new</span> Dictionary&lt;<span class="highlight-keyword">string</span>, <span class="highlight-keyword">string</span>&gt;();
    contextItemDic[oldDbSettingName] = newDbSettingName;
    <span class="highlight-keyword">return</span> ShareDbSettingContextItem.UseScopeValue(contextItemDic);
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAAEAAA");</script></div><div class="collapsibleAreaRegion" id="Section2"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID2RB')" onkeypress="SectionExpandCollapse_CheckKey('ID2RB', event)" tabindex="0"><img id="ID2RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />Repository 数据源切换</span></div><div id="ID2RBSection" class="collapsibleSection"><p>对 Repository 的数据源进行切换，我们可以实现实体的读写分离。</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAADAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAADAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAADAAA');return false;" title="复制">复制</a></div></div><div id="ID0EAAADAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">public</span> <span class="highlight-keyword">void</span> ET_Repository_RedirectDbSetting()
{
    <span class="highlight-keyword">var</span> bookRepo = RF.ResolveInstance&lt;BookRepository&gt;();
    <span class="highlight-comment">////默认主库为UnitTestEntityRepositoryDataProvider.DbSettingName</span>
    bookRepo.Save(<span class="highlight-keyword">new</span> Book());
    <span class="highlight-comment">//切换为UnitTestEntityRepositoryDataProvider.DbSettingName_Duplicate</span>
    <span class="highlight-keyword">using</span> (RdbDataProvider.RedirectDbSetting(UnitTestEntityRepositoryDataProvider.DbSettingName,
                    UnitTestEntityRepositoryDataProvider.DbSettingName_Duplicate))
    {
        Assert.AreEqual(<span class="highlight-number">0</span>, bookRepo.CountAll());
    }
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAADAAA");</script></div><div class="collapsibleAreaRegion" id="Section1"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID3RB')" onkeypress="SectionExpandCollapse_CheckKey('ID3RB', event)" tabindex="0"><img id="ID3RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />数据库生成切换</span></div><div id="ID3RBSection" class="collapsibleSection"><p>Rafy 运行时，会完成数据库的生成。我们在做数据备份时，希望新建一个数据库进行备份，以下代码即实现了数据库备份。</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAACAAA');return false;" title="复制">复制</a></div></div><div id="ID0EAAACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">public</span> <span class="highlight-keyword">void</span> DMT_AutoMigrate_ChangeDbSetting()
{
    <span class="highlight-keyword">using</span> (RdbDataProvider.RedirectDbSetting(UnitTestEntityRepositoryDataProvider.DbSettingName,
            UnitTestEntityRepositoryDataProvider.DbSettingName_Duplicate))
    {
        <span class="highlight-keyword">using</span> (<span class="highlight-keyword">var</span> c = <span class="highlight-keyword">new</span> RafyDbMigrationContext(UnitTestEntityRepositoryDataProvider.DbSettingName_Duplicate))
        {
            <span class="highlight-comment">/// 实体元数据默认设置的连接字符串</span>
            <span class="highlight-comment">/// 如果切换新的数据库需要设置，否则不用设置</span>
            c.ClassMetaReader.EntityDbSettingName = UnitTestEntityRepositoryDataProvider.DbSettingName;
            c.HistoryRepository = <span class="highlight-keyword">new</span> DbHistoryRepository();
            c.RunDataLossOperation = DataLossOperation.All;
            c.AutoMigrate();
        }
    }
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAACAAA");</script></div><div class="collapsibleAreaRegion" id="notice"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID4RB')" onkeypress="SectionExpandCollapse_CheckKey('ID4RB', event)" tabindex="0"><img id="ID4RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />注意</span></div><div id="ID4RBSection" class="collapsibleSection">
        目前只支持相同数据库类型间进行切换。例如：运行期不允许从 MySql 切换到 SQL Server 数据源。
      </div></div></div><div id="pageFooter" class="pageFooter">有问题请联系 9474649@qq.com。<div class="feedbackLink">有关这个主题的评论请发邮件到
        <a id="HT_MailLink" href="mailto:9474649%40qq.com?Subject=Rafy User Guide">发送反馈</a></div>
        <script type="text/javascript">
        var HT_mailLink = document.getElementById("HT_MailLink");
        var HT_mailLinkText = HT_mailLink.innerHTML;
        HT_mailLink.href += ": " + document.title + "\u0026body=" + encodeURIComponent("Your feedback is used to improve the documentation and the product. Your e-mail address will not be used for any other purpose and is disposed of after the issue you report is resolved. While working to resolve the issue that you report, you may be contacted via e-mail to get further details or clarification on the feedback you sent. After the issue you report has been addressed, you may receive an e-mail to let you know that your feedback has been addressed.");
        HT_mailLink.innerHTML = HT_mailLinkText;
        </script></div></body></html>