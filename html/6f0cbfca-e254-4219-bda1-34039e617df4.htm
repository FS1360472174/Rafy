<html><head><meta http-equiv="X-UA-Compatible" content="IE=edge" /><link rel="shortcut icon" href="../icons/favicon.ico" /><link rel="stylesheet" type="text/css" href="../styles/branding.css" /><link rel="stylesheet" type="text/css" href="../styles/branding-zh-CN.css" /><script type="text/javascript" src="../scripts/branding.js"> </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>实体缓存</title><meta name="Language" content="zh-cn" /><meta name="Microsoft.Help.Id" content="6f0cbfca-e254-4219-bda1-34039e617df4" /><meta name="Description" content="缓存 -- 日常开发常用基础组件之一。" /><meta name="Microsoft.Help.ContentType" content="Concepts" /><meta name="BrandingAware" content="true" /><link type="text/css" rel="stylesheet" href="../styles/highlight.css" /><script type="text/javascript" src="../scripts/highlight.js"> </script><link rel="stylesheet" type="text/css" href="../styles/branding-Website.css" /><script type="text/javascript" src="../scripts/jquery-1.11.0.min.js"></script><script type="text/javascript" src="../scripts/branding-Website.js"></script><script type="text/javascript" src="../scripts/clipboard.min.js"></script></head><body onload="OnLoad('cs')"><input type="hidden" id="userDataCache" class="userDataStyle" /><div class="pageHeader" id="PageHeader">Rafy User Guide<form id="SearchForm" method="get" action="#" onsubmit="javascript:TransferToSearchPage(); return false;"><input id="SearchTextBox" type="text" maxlength="200" /><button id="SearchButton" type="submit"></button></form></div><div class="pageBody"><div class="leftNav" id="leftNav"><div id="tocNav"><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy User Guide" tocid="roottoc">Rafy User Guide</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy框架" tocid="69b641cf-d1fe-4f06-877f-b479d268a3fc">Rafy框架</a></div><div class="toclevel1" data-toclevel="1" data-childrenloaded="true"><a class="tocExpanded" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="c8e6cd25-c674-4cd1-9880-816d11f58eb8.htm" title="领域实体框架" tocid="c8e6cd25-c674-4cd1-9880-816d11f58eb8">领域实体框架</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="61dd4914-8d8b-4488-857c-f83b553137d8.htm" title="安装" tocid="61dd4914-8d8b-4488-857c-f83b553137d8">安装</a></div><div class="toclevel2" data-toclevel="2"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="dda8ce30-3c9c-48c6-b162-2c447bf9112e.htm" title="快速试用" tocid="dda8ce30-3c9c-48c6-b162-2c447bf9112e">快速试用</a></div><div class="toclevel2" data-toclevel="2"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="e9998e68-31e8-47d6-9e28-829aade5044e.htm" title="领域实体" tocid="e9998e68-31e8-47d6-9e28-829aade5044e">领域实体</a></div><div class="toclevel2" data-toclevel="2"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="6b377084-3fc9-4bf6-94d7-bc9a42ed82a7.htm" title="实体仓库" tocid="6b377084-3fc9-4bf6-94d7-bc9a42ed82a7">实体仓库</a></div><div class="toclevel2" data-toclevel="2"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="793cbe04-7265-4de9-a7d7-fb890aebc525.htm" title="领域逻辑" tocid="793cbe04-7265-4de9-a7d7-fb890aebc525">领域逻辑</a></div><div class="toclevel2" data-toclevel="2"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="0f6e3552-029f-4a32-9655-e4b6fb22edcc.htm" title="对象关系映射" tocid="0f6e3552-029f-4a32-9655-e4b6fb22edcc">对象关系映射</a></div><div class="toclevel2" data-toclevel="2"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="f55333b8-3524-4a07-99bc-6a1cdb6be6b4.htm" title="部署" tocid="f55333b8-3524-4a07-99bc-6a1cdb6be6b4">部署</a></div><div class="toclevel2" data-toclevel="2"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="6299ee13-40f8-41c7-b3d4-ed2542f00cc1.htm" title="插件级扩展" tocid="6299ee13-40f8-41c7-b3d4-ed2542f00cc1">插件级扩展</a></div><div class="toclevel2 current" data-toclevel="2"><a data-tochassubtree="false" href="6f0cbfca-e254-4219-bda1-34039e617df4.htm" title="实体缓存" tocid="6f0cbfca-e254-4219-bda1-34039e617df4">实体缓存</a></div><div class="toclevel2" data-toclevel="2"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="2599e4bb-d313-4b78-892d-654f3e9acba8.htm" title="其它" tocid="2599e4bb-d313-4b78-892d-654f3e9acba8">其它</a></div></div><div id="tocResizableEW" onmousedown="OnMouseDown(event);"></div><div id="TocResize" class="tocResize"><img id="ResizeImageIncrease" src="../icons/TocOpen.gif" onclick="OnIncreaseToc()" alt="点击或拖拽改变大小" title="点击或拖拽改变大小" /><img id="ResizeImageReset" src="../icons/TocClose.gif" style="display:none" onclick="OnResetToc()" alt="点击或拖拽改变大小" title="点击或拖拽改变大小" /></div></div><div class="topicContent" id="TopicContent"><table class="titleTable"><tr><td class="titleColumn"><h1>实体缓存</h1></td></tr></table><span class="introStyle"></span> <div class="introduction"><p>本页包含以下内容：</p><ul class="autoOutline"><li class="outlineSectionEntry"><a href="#intro">简介</a></li><li class="outlineSectionEntry"><a href="#appUsage">使用示例</a></li><li class="outlineSectionEntry"><a href="#implement">扩展</a></li></ul></div><div class="collapsibleAreaRegion" id="intro"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID0RB')" onkeypress="SectionExpandCollapse_CheckKey('ID0RB', event)" tabindex="0"><img id="ID0RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />简介</span></div><div id="ID0RBSection" class="collapsibleSection"><p>
          缓存 -- 日常开发常用基础组件之一。
        </p><p>
          在 Rafy 这套框架里面也为大家提供了几个常用的缓存组件（不够还可以自己扩展）。
        </p><div class="mediaNear"><img alt="Cache 01" src="../media/Cache_01.png" /></div><ul><li><p>内存缓存(MemoryCache)</p><p>　　使用当前服务器的内存或客户端所在电脑的内存缓存数据项。</p><p>　　特点：速度快的要命。</p></li><li><p>磁盘缓存(SQLCompactCache)</p><p>　　使用 SQL Compact 本地数据库缓存数据项。</p><p>　　特点：缓存数据项不会因为应用宕机或离线而丢失。</p></li><li><p>每个 HTTP 请求的缓存(PerHttpRequestCache)</p><p>　　在每个 http 请求中，第一次获取数据时进行一次缓存，在当前生命周期内可以直接从缓存中读取数据项。http 生命周期结束，缓存自动释放。</p><p>　　特点：只能用于 .NET Web 应用程序。被缓存数据项仅在 http 生命周期内有效。</p><p>　　建议：不要存放过大的数据。以避免增加 GC 的压力。</p></li><li><p>使用内存缓存和磁盘缓存的二级缓存(HybirdCache)</p><p>　　同时拥有内存缓存和磁盘缓存的特点。</p></li></ul><p>
          上面列出来了 Rafy 中实现的缓存组件，也说明了每个缓存组件的特点。那么具体使用时选用哪个组件呢？这没有一个固定答案，需要结合自己的应用程序的业务场景来选择。
        </p></div><div class="collapsibleAreaRegion" id="appUsage"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID2RB')" onkeypress="SectionExpandCollapse_CheckKey('ID2RB', event)" tabindex="0"><img id="ID2RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />使用示例</span></div><div id="ID2RBSection" class="collapsibleSection"><p>在 Cache 这个抽象类中提供了一个静态属性，也是 Rafy 缓存组件中默认的实现，即 MemoryCache。如果要使用其它缓存组件请参见下面的示例。</p><ul><li><p>Cache 的默认实现（即 MemoryCache）的开箱即用的使用方式</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAADAACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAADAACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID1EAADAACAAA');return false;" title="复制">复制</a></div></div><div id="ID1EAADAACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-comment">// 添加缓存</span>
<span class="highlight-keyword">var</span> result = Cache.Default.Add(<span class="highlight-literal">"rafy"</span>, <span class="highlight-literal">"rafy orm v5"</span>, <span class="highlight-keyword">null</span>);
Assert.IsTrue(result);

<span class="highlight-comment">// 获取缓存</span>
<span class="highlight-keyword">var</span> cacheItem = Cache.Default.Get(<span class="highlight-literal">"rafy"</span>);
Assert.AreEqual(cacheItem.ToString(), <span class="highlight-literal">"rafy orm v5"</span>);

<span class="highlight-comment">// 移除缓存</span>
Cache.Default.Remove(<span class="highlight-literal">"rafy"</span>);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAADAACAAA");</script></li><li><p>PerHttpRequestCache</p><p>　　在一个 HTTP 生命周期内只需要 new 一次。尽量配合 IoC/DI 框架使用。</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAACAACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAACAACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID1EAACAACAAA');return false;" title="复制">复制</a></div></div><div id="ID1EAACAACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-comment">// 创建一个 PerHttpRequestCache 对象的实例</span>
<span class="highlight-keyword">var</span> preHttpRequestCache = <span class="highlight-keyword">new</span> PerHttpRequestCache();

<span class="highlight-comment">// 添加缓存</span>
<span class="highlight-keyword">var</span> result = preHttpRequestCache.Add(<span class="highlight-literal">"rafy"</span>, <span class="highlight-literal">"rafy orm v5"</span>, <span class="highlight-keyword">null</span>);
Assert.IsTrue(result);

<span class="highlight-comment">// 获取缓存</span>
<span class="highlight-keyword">var</span> cacheItem = preHttpRequestCache.Get(<span class="highlight-literal">"rafy"</span>);
Assert.AreEqual(cacheItem.ToString(), <span class="highlight-literal">"rafy orm v5"</span>);

<span class="highlight-comment">// 移除缓存</span>
preHttpRequestCache.Remove(<span class="highlight-literal">"rafy"</span>);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAACAACAAA");</script></li><li><p>SQLCompactCache</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAABAACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAABAACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID1EAABAACAAA');return false;" title="复制">复制</a></div></div><div id="ID1EAABAACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-comment">// 创建一个 SQLCompactCache 对象的实例</span>
<span class="highlight-keyword">var</span> sqlCompactCache = <span class="highlight-keyword">new</span> SQLCompactCache(<span class="highlight-literal">"rafy_cache.sdf"</span>);

<span class="highlight-comment">// 添加缓存</span>
<span class="highlight-keyword">var</span> result = sqlCompactCache.Add(<span class="highlight-literal">"rafy"</span>, <span class="highlight-literal">"rafy orm v5"</span>, <span class="highlight-keyword">null</span>);
Assert.IsTrue(result);

<span class="highlight-comment">// 获取缓存</span>
<span class="highlight-keyword">var</span> cacheItem = sqlCompactCache.Get(<span class="highlight-literal">"rafy"</span>);
Assert.AreEqual(cacheItem.ToString(), <span class="highlight-literal">"rafy orm v5"</span>);

<span class="highlight-comment">// 移除缓存</span>
sqlCompactCache.Remove(<span class="highlight-literal">"rafy"</span>);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAABAACAAA");</script></li><li><p>HybirdCache</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAAAAACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAAAAACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID1EAAAAACAAA');return false;" title="复制">复制</a></div></div><div id="ID1EAAAAACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-comment">// 创建一个 HybirdCache 对象的实例</span>
<span class="highlight-keyword">var</span> hybirdCache = <span class="highlight-keyword">new</span> HybirdCache(<span class="highlight-literal">"rafy_cache.sdf"</span>);

<span class="highlight-comment">// 添加缓存</span>
<span class="highlight-keyword">var</span> result = hybirdCache.Add(<span class="highlight-literal">"rafy"</span>, <span class="highlight-literal">"rafy orm v5"</span>, <span class="highlight-keyword">null</span>);
Assert.IsTrue(result);

<span class="highlight-comment">// 获取缓存</span>
<span class="highlight-keyword">var</span> cacheItem = hybirdCache.Get(<span class="highlight-literal">"rafy"</span>);
Assert.AreEqual(cacheItem.ToString(), <span class="highlight-literal">"rafy orm v5"</span>);

<span class="highlight-comment">// 移除缓存</span>
hybirdCache.Remove(<span class="highlight-literal">"rafy"</span>);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAAAAACAAA");</script></li></ul></div><div class="collapsibleAreaRegion" id="implement"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID3RB')" onkeypress="SectionExpandCollapse_CheckKey('ID3RB', event)" tabindex="0"><img id="ID3RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />扩展</span></div><div id="ID3RBSection" class="collapsibleSection"><p>
          在分布式环境中应用都是群集部署。大家使用缓存时一般会选择 Redis 或 Memcached 或 MongoDB 等等。目前 Rafy 并没有提供对上一句所说的这些分布式缓存框架的支持。
          但大家可以通过简单的扩展就让 Rafy 支持这些分布式缓存框架。假设我们要让 Rafy 支持 Redis 。
        </p><p>示例代码</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAAABAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAAABAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID1EAAABAAA');return false;" title="复制">复制</a></div></div><div id="ID1EAAABAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">public</span> <span class="highlight-keyword">sealed</span> <span class="highlight-keyword">class</span> RedisCache : Cache
{
    <span class="highlight-keyword">protected</span> <span class="highlight-keyword">internal</span> <span class="highlight-keyword">override</span> StoredValue GetCacheItemCore(<span class="highlight-keyword">string</span> region, <span class="highlight-keyword">string</span> key)
    {
        <span class="highlight-comment">// 使用 Redis 驱动获取指定域的缓存项</span>
        <span class="highlight-keyword">throw</span> <span class="highlight-keyword">new</span> NotImplementedException();
    }

    <span class="highlight-keyword">protected</span> <span class="highlight-keyword">internal</span> <span class="highlight-keyword">override</span> <span class="highlight-keyword">bool</span> AddCore(<span class="highlight-keyword">string</span> region, <span class="highlight-keyword">string</span> key, StoredValue <span class="highlight-keyword">value</span>)
    {
        <span class="highlight-comment">// 使用 Redis 驱动添加缓存项到指定域</span>
        <span class="highlight-keyword">throw</span> <span class="highlight-keyword">new</span> NotImplementedException();
    }

    <span class="highlight-keyword">protected</span> <span class="highlight-keyword">internal</span> <span class="highlight-keyword">override</span> <span class="highlight-keyword">void</span> RemoveCore(<span class="highlight-keyword">string</span> region, <span class="highlight-keyword">string</span> key)
    {
        <span class="highlight-comment">// 使用 Redis 驱动移除指定域的缓存项</span>
        <span class="highlight-keyword">throw</span> <span class="highlight-keyword">new</span> NotImplementedException();
    }

    <span class="highlight-keyword">protected</span> <span class="highlight-keyword">internal</span> <span class="highlight-keyword">override</span> <span class="highlight-keyword">void</span> ClearRegionCore(<span class="highlight-keyword">string</span> region)
    {
        <span class="highlight-comment">// 使用 Redis 驱动移除指定域的所有缓存项</span>
        <span class="highlight-keyword">throw</span> <span class="highlight-keyword">new</span> NotImplementedException();
    }

    <span class="highlight-keyword">protected</span> <span class="highlight-keyword">internal</span> <span class="highlight-keyword">override</span> <span class="highlight-keyword">void</span> ClearCore()
    {
        <span class="highlight-comment">// 使用 Redis 驱动移除所有缓存项</span>
        <span class="highlight-keyword">throw</span> <span class="highlight-keyword">new</span> NotImplementedException();
    }
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAAABAAA");</script></div></div></div><div id="pageFooter" class="pageFooter">有问题请联系 9474649@qq.com。<div class="feedbackLink">有关这个主题的评论请发邮件到
        <a id="HT_MailLink" href="mailto:9474649%40qq.com?Subject=Rafy User Guide">发送反馈</a></div>
        <script type="text/javascript">
        var HT_mailLink = document.getElementById("HT_MailLink");
        var HT_mailLinkText = HT_mailLink.innerHTML;
        HT_mailLink.href += ": " + document.title + "\u0026body=" + encodeURIComponent("Your feedback is used to improve the documentation and the product. Your e-mail address will not be used for any other purpose and is disposed of after the issue you report is resolved. While working to resolve the issue that you report, you may be contacted via e-mail to get further details or clarification on the feedback you sent. After the issue you report has been addressed, you may receive an e-mail to let you know that your feedback has been addressed.");
        HT_mailLink.innerHTML = HT_mailLinkText;
        </script></div></body></html>